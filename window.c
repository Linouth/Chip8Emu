#include <stdio.h>
#include <stdlib.h>

#include <GL/glew.h>
#include <GL/glut.h>

#define WIDTH 640
#define HEIGHT 320

double ytogl(int y) {
    // Convert Y screen cooridnate to OpenGL Clipping Area coordinate
    double Py = 2.0/HEIGHT;
    return (y * Py) - 1;
}
double xtogl(int y) {
    // Convert X screen coordinate to OpenGL Clipping Area coordinate
    double Px = 2.0/WIDTH;
    return (y * Px) - 1;
}


void Rect(int x, int y, int size) {
    glBegin(GL_QUADS);
        glVertex2d(xtogl(x), ytogl(y));
        glVertex2d(xtogl(x+size), ytogl(y));
        glVertex2d(xtogl(x+size), ytogl(y+size));
        glVertex2d(xtogl(x), ytogl(y+size));
    glEnd();
}


void RenderArray() {
    uint8_t sprite[] = {
        0b10001000,
        0b10001000,
        0b11111000,
        0b00100000,
        0b00101111,
        0b00001001,
        0b00001001,
        0b00001111
    };

    uint8_t sprite2[] = {
        0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00,
        0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00,
        0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00,
        0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff,
        0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff
    };
    int height = 8;

    glTexImage2D(GL_TEXTURE_2D, 0, GL_LUMINANCE, 8,8, 0, GL_LUMINANCE, GL_UNSIGNED_BYTE, sprite2);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);
    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);

    glEnable(GL_TEXTURE_2D);
    glBegin(GL_QUADS);
    glTexCoord2f(0.0, 1.0);
    glVertex2f(-1.0, -1.0);
    glTexCoord2f(1.0, 1.0);
    glVertex2f(1.0, -1.0);
    glTexCoord2f(1.0, 0.0);
    glVertex2f(1.0, 1.0);
    glTexCoord2f(0.0, 0.0);
    glVertex2f(-1.0, 1.0);
    glEnd();

    /* glBitmap(8, 8, 0.0, 0.0, 0.0, 0.0, sprite); */
    glFlush();
}


void RenderScreen() {
    unsigned char *buffer8 = calloc( 64*32, 1);
    unsigned char *b8 = buffer8;
    unsigned char screen_dat[] = {
      0x70, 0xff, 0x6d, 0x01, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x11, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x60, 0x90, 0x90, 0x90, 0x60, 0x20, 0x60, 0x20,
      0x20, 0x70, 0x60, 0x90, 0x20, 0x40, 0xf0, 0xe0,
      0x10, 0x20, 0x10, 0xe0, 0x90, 0x90, 0xf0, 0x10,
      0x10, 0xf0, 0x80, 0xe0, 0x10, 0xe0, 0x70, 0x80,
      0xf0, 0x90, 0xf0, 0xf0, 0x20, 0x40, 0x40, 0x40,
      0x60, 0x90, 0x60, 0x90, 0x60, 0x60, 0x90, 0x70,
      0x10, 0x70, 0x60, 0x90, 0xf0, 0x90, 0x90, 0xe0,
      0x90, 0xe0, 0x90, 0xe0, 0x60, 0x90, 0x80, 0x90,
      0x60, 0xe0, 0x90, 0x90, 0x90, 0xe0, 0xf0, 0x80,
      0xe0, 0x80, 0xf0, 0xf0, 0x80, 0xe0, 0x80, 0x80,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    unsigned char *fb = screen_dat;
    for (int i=0; i < ((64/8)*32); i++)
    {
        uint8_t bw_pix = fb[0];
        if (bw_pix & 0x80) b8[0] = 0xFF; else b8[0] = 0;
        if (bw_pix & 0x40) b8[1] = 0xFF; else b8[1] = 0;
        if (bw_pix & 0x20) b8[2] = 0xFF; else b8[2] = 0;
        if (bw_pix & 0x10) b8[3] = 0xFF; else b8[3] = 0;
        if (bw_pix & 0x08) b8[4] = 0xFF; else b8[4] = 0;
        if (bw_pix & 0x04) b8[5] = 0xFF; else b8[5] = 0;
        if (bw_pix & 0x02) b8[6] = 0xFF; else b8[6] = 0;
        if (bw_pix & 0x01) b8[7] = 0xFF; else b8[7] = 0;           
        b8 += 8;
        fb++;
    }

    glTexImage2D(GL_TEXTURE_2D, 0, GL_LUMINANCE, 64,32, 0, GL_LUMINANCE, GL_UNSIGNED_BYTE, buffer8);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);
    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);

    glColor3f(1.0, 1.0, 1.0);
    /* glPixelZoom(1.0, -1.0); */
    /* glBitmap(64, 32, 0.0, 0.0, 0.0, 0.0, screen_dat); */

    /* glDrawPixels(64, 32, GL_COLOR_INDEX, GL_BITMAP, screen_dat); */

    glEnable(GL_TEXTURE_2D);
    glBegin(GL_QUADS);
    glTexCoord2f(0.0, 1.0);
    glVertex2f(-1.0, -1.0);
    glTexCoord2f(1.0, 1.0);
    glVertex2f(1.0, -1.0);
    glTexCoord2f(1.0, 0.0);
    glVertex2f(1.0, 1.0);
    glTexCoord2f(0.0, 0.0);
    glVertex2f(-1.0, 1.0);
    glEnd();




    glFlush();
}


void RenderSceneCB() {
    glClear(GL_COLOR_BUFFER_BIT);

    /* glMatrixMode(GL_PROJECTION); */
    /* glLoadIdentity(); */
    /* gluOrtho2D(-1.0, 1.0, -1.0, 1.0); */

    /* Rect(0, 0, 10); */
    /* Rect(0, 310, 10); */
    /* Rect(630, 0, 10); */
    /* Rect(630, 310, 10); */

    RenderArray();
    /* RenderScreen(); */

    glutSwapBuffers();
}

void init() {
    glClearColor(0.0, 0.0, 0.0, 0.0);
    glShadeModel(GL_FLAT);
    glPixelStorei(GL_UNPACK_ALIGNMENT, 1);
}

void reshape(int w, int h)
{
   glViewport(0, 0, (GLsizei) w, (GLsizei) h);
   glMatrixMode(GL_PROJECTION);
   glLoadIdentity();
   glOrtho (0, w, 0, h, -1.0, 1.0);
   glMatrixMode(GL_MODELVIEW);
}


int main(int argc, char *argv[]) {


    glutInit(&argc, argv);
    glutInitDisplayMode(GLUT_DOUBLE | GLUT_RGBA);
    glutInitWindowSize(WIDTH, HEIGHT);
    glutInitWindowPosition(100, 100);
    glutCreateWindow("Chip8");

    init();

    /* glutReshapeFunc(reshape); */
    glutDisplayFunc(RenderSceneCB);
    /* glutDisplayFunc(RenderScreen); */

    glutMainLoop();
    return 0;
}

